name: Build APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-venv \
          openjdk-11-jdk \
          zip unzip git wget curl \
          build-essential \
          python3-dev \
          cython3
        
    - name: Install Buildozer and dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer kivy
        
    - name: Build with Buildozer
      run: |
        cd app
        buildozer android debug
        
    - name: Find and list APK files
      run: |
        echo "=== Searching for APK files ==="
        find . -name "*.apk" -type f
        echo "=== Contents of app/bin/ ==="
        ls -la app/bin/ || echo "bin directory not found"
        
    - name: Upload APK directly
      uses: actions/upload-artifact@v4
      with:
        name: arabic-ocr-apk
        path: |
          app/bin/*.apk
          app/bin/*.apk.*
        retention-days: 30
        
    - name: Upload entire bin folder
      uses: actions/upload-artifact@v4
      with:
        name: app-bin-folder
        path: app/bin/
        retention-days: 30
